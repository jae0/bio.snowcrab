# Dynamical Fishery Model 

## Purpose

Prepare aggregated time-series data for inference using a Bayesian fishery model. Currently, the default model is the discrete logistic formulation. It is labelled, "logistic_historical" in the following. There are other variations possible. See the calling code. 

---

## Prepare data for discrete logistic models

This step requires 03.biomass_index_carstm.r to be completed as it statistically models the survey samples in space and time and then aggregates across space for a less biased estimate/index of abundance. 

  [bio.snowcrab/inst/scripts/03.biomass_index_carstm.r](bio.snowcrab/inst/scripts/03.biomass_index_carstm.r)  

Make sure to have run at the very bottom of the file:

```R
## note the output directory .. this location is used below
fishery_model_data_inputs( year.assessment=year.assessment,  type="biomass_dynamics", for_julia=TRUE ) 
```


---

## Model fitting and parameter inference

Now that data inputs are complete, we can continue on to model fitting and inference. This is done in (Julia)[https://julialang.org/]. 

First install or download Julia and install appropriate libraries from withing Julia. 

There are two ways you can use this. 

  1. Run within Julia directly.

    This method is most flexible and [documented here](https://github.com/jae0/dynamical_model/blob/master/snowcrab/04.snowcrab_fishery_model.md), where more options are also shown.  

  2. Run within R and indirectly call Julia, using the JuliaCall R-library (install that too).

    This method is shown below.


```R
 
  year.assessment = 2022

  p = bio.snowcrab::load.environment( year.assessment=year.assessment )


  if (0) {
      # to set up:
      # julia_setup(JULIA_HOME = "the folder that contains julia binary")
      # options(JULIA_HOME = "the folder that contains julia binary")
      # Set JULIA_HOME in command line environment.
      install.packages("JuliaCall")
      install_julia()
  }

  # load JuliaCall interface
  library(JuliaCall)
  julia <- julia_setup()


  # set up paths: adjust to local copy of bio.snowcrab library
  julia_scripts_location = system.file( "julia", package="bio.snowcrab" )

  # julia_source cannot traverse directories .. temporarily switch directory
  currentwd = getwd() 
 
    setwd(julia_scripts_location) 

    julia_assign( "random_seed", 12345 )

    julia_source( "snowcrab_startup.jl" )  # load/install libraries and setup directories
    julia_source( "logistic_discrete_functions.jl" )  # core modelling functions


    # load data; alter file path as required
    fndat  = file.path( data_root, "bio.snowcrab", "modelled", "1999_present_fb", "fishery_model_results", "turing1", "biodyn_biomass.RData" )
    o = load( fndat, convert=true)
    julia_assign("o", o)


    ## set year of assessment in julia environment
    julia_assign("year_assessment", year.assessment)  # copy data into julia session

    # location of data
    julia_assign("bio_data_directory", data_root)  # copy data into julia session
    julia_assign("outputs_directory", file.path(data_root, "bio.snowcrab", "fishery_model" ))  # copy data into julia session


    # Model and compute predictions for each area

    # cfanorth:    
    julia_assign( "aulab", "cfanorth" )  # copy data into julia session
    julia_source( "logistic_discrete.jl" )   # modelling and outputs

    # cfasouth:    
    julia_assign( "aulab", "cfasouth")  # copy data into julia session
    julia_source( "logistic_discrete.jl" )   # modelling and outputs

    # cfa4x:    
    julia_assign( "aulab", "cfa4x" )  # copy data into julia session
    julia_source( "logistic_discrete.jl" )   # modelling and outputs

  setwd(currentwd) # revert work directory

  
  # to move data into R
  # objects that might be useful
  # m, num, bio, trace, Fkt, FR, FM 
  bio = julia_eval("bio")  # standard deviations

 

```

Now that results have been generated and saved, we can continue with a few computations and predictions.

---

## Predictions and figures


```julia
# n scaled, n unscaled, biomass of fb with and without fishing, model_traces, model_times 
m, num, bio, trace, trace_bio, trace_time = fishery_model_predictions(res ) 

# fishing (kt), relative Fishing mortality, instantaneous fishing mortality:
Fkt, FR, FM = fishery_model_mortality() 

# save a few data files as semicolon-delimited CSV's for use outside Julia
summary_fn = joinpath( model_outdir, string("results_turing", "_", aulab, "_summary", ".csv" ) )  
CSV.write( summary_fn,  summarize( res ), delim=";" )  # use semicolon as , also used in parm names
  
bio_fn1 = joinpath( model_outdir, string("results_turing", "_", aulab, "_bio_fishing", ".csv" ) )  
CSV.write( bio_fn1,  DataFrame(bio[:,:], :auto), delim=";" )  # use semicolon as , also used in parm names

fm_fn = joinpath( model_outdir, string("results_turing", "_", aulab, "_fm", ".csv" ) )  
CSV.write( fm_fn,  DataFrame( FM, :auto), delim=";" )  # use semicolon as , also used in parm names


# annual snapshots of biomass (kt) 
pl = fishery_model_plot( toplot=("survey", "fishing" ) )
savefig(pl, joinpath( model_outdir, string("plot_predictions_", aulab, ".pdf") )  )

# plot fishing mortality, , 
pl = fishery_model_plot( toplot="fishing_mortality" )
# pl = plot(pl, ylim=(0, 0.65))
savefig(pl, joinpath( model_outdir, string("plot_fishing_mortality_", aulab, ".pdf") )  )

# HCR plot
pl = fishery_model_plot( toplot="harvest_control_rule", n_sample=1000 ) #, alphav=0.01 )  # hcr
# pl = plot(pl, ylim=(0, 0.65))
savefig(pl, joinpath( model_outdir, string("plot_hcr_", aulab, ".pdf") )  )


```

And that is it. Continue with report generation either through [Markdown](./10.snowcrab_r_markdown_documents.md) or a word processor.




