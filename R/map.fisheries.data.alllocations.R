
map.fisheries.data.alllocations = function(p, additional_features=NULL, plot_crs  = st_crs( projection_proj4string("lonlat_wgs84")) ){ 
    # maps all fishing locations

    lgbk = logbook.db( DS="fishing.grounds.global",  p=p )
    lgbk$log_effort = log(lgbk$total.effort)
    i = which( is.finite( lgbk$log_effort ))
    lgbk = lgbk[i, ]

    lgbk = st_as_sf(lgbk, coords=c("plon", "plat"), crs=p$aegis_proj4string_planar_km )

    lgbk = st_transform(lgbk, crs=plot_crs)
    lgbk = cbind(lgbk,  st_coordinates(lgbk) )  #X, Y
 
    o = ggplot() +
      geom_point( data = lgbk, aes(x=X, y=Y, colour=log_effort), alpha=0.9, size=1.2 ) +  
      scale_colour_gradientn(colours = rev(RColorBrewer::brewer.pal(5, "RdYlBu")) ) +
      coord_sf(xlim =p$corners$lon, ylim =p$corners$lat, expand = FALSE, crs=plot_crs, default_crs=plot_crs) 

    if (!is.null(additional_features)) o = o + additional_features

    o = o +       
      theme(
        axis.line=element_blank(),
        # axis.text.x=element_blank(),
        # axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(), 
        legend.position = "inside",
        legend.position.inside= c( 0.925, 0.15 ) ,
        legend.title = element_text("Effort", vjust = +2),
        # panel.background=element_blank(),
        panel.background = element_rect(fill ="white"),
        panel.border=element_blank(),
        # panel.grid.major=element_blank(),
        panel.grid.major = element_line(color = "grey"),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(), 
        plot.caption = element_text(hjust = 0, size = 12)
    )

    media_loc = file.path( p$datadir, "media" )
    fn = file.path( media_loc, "snowcrab_fishing.png" )
    print(fn)
    ggsave( fn, o )
}
